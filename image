<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Image Resizer & Cropper</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        /* Basic styling to make it look neat */
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .tool-container { background: #f9f9f9; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button { padding: 8px 12px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px 0; }
    </style>
</head>
<body>

    <div class="tool-container">
        <h2>Upload, Crop, Rotate & Compress</h2>
        <input type="file" id="imageInput" accept="image/*">
        
        <div id="editorSpace" style="display: none; width: 100%; margin-top: 15px;">
            <div style="max-height: 400px; overflow: hidden;">
                <img id="imageToCrop" style="max-width: 100%; display: block;">
            </div>
            
            <div class="controls" style="margin-top: 15px;">
                <button onclick="rotateLeft()">↺ Rotate Left</button>
                <button onclick="rotateRight()">↻ Rotate Right</button>
            </div>

            <div class="compression-controls" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <label><strong>Target Size (KB):</strong> </label>
                <input type="number" id="targetKB" placeholder="e.g., 50">
                <button onclick="processAndCompress()" style="background: #28a745;">Crop & Compress</button>
            </div>
        </div>

        <div id="resultArea" style="margin-top: 20px; text-align: center;"></div>
    </div>

    <script>
        let cropper;
        const imageInput = document.getElementById('imageInput');
        const imageToCrop = document.getElementById('imageToCrop');
        const editorSpace = document.getElementById('editorSpace');

        // Load Image into Cropper
        imageInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    imageToCrop.src = event.target.result;
                    editorSpace.style.display = 'block';
                    
                    if (cropper) { cropper.destroy(); }
                    
                    cropper = new Cropper(imageToCrop, {
                        viewMode: 2, 
                        autoCropArea: 1,
                        background: true
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        // Rotation Controls
        function rotateLeft() { cropper.rotate(-90); }
        function rotateRight() { cropper.rotate(90); }

        // Smart Compression Logic (Anti-Blur)
        function processAndCompress() {
            const targetKB = parseFloat(document.getElementById('targetKB').value);
            if (!targetKB) return alert('Please enter a target KB size.');

            document.getElementById('resultArea').innerHTML = "<em>Compressing... Please wait.</em>";

            const croppedCanvas = cropper.getCroppedCanvas({
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });

            const targetBytes = targetKB * 1024;
            
            compressCanvas(croppedCanvas, targetBytes, 0.9, function(finalBlob) {
                const resultArea = document.getElementById('resultArea');
                const finalUrl = URL.createObjectURL(finalBlob);
                const finalKB = (finalBlob.size / 1024).toFixed(2);
                
                resultArea.innerHTML = `
                    <h3 style="color: #28a745;">Success! Final Size: ${finalKB} KB</h3>
                    <img src="${finalUrl}" style="max-width: 100%; border: 1px solid #ccc; margin-bottom: 15px; border-radius: 4px;">
                    <br>
                    <a href="${finalUrl}" download="compressed_image.jpg" style="padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; display: inline-block;">Download Final Image</a>
                `;
            });
        }

        // Recursive Compression Function
        function compressCanvas(canvas, targetBytes, quality, callback) {
            canvas.toBlob(function(blob) {
                if (!blob) return;

                if (blob.size <= targetBytes || quality <= 0.4) {
                    if (blob.size > targetBytes) {
                        shrinkDimensions(canvas, targetBytes, callback);
                    } else {
                        callback(blob); 
                    }
                    return;
                }

                compressCanvas(canvas, targetBytes, quality - 0.1, callback);
            }, 'image/jpeg', quality);
        }

        // Dimension Shrinker
        function shrinkDimensions(originalCanvas, targetBytes, callback) {
            const scaleFactor = 0.8; 
            const newWidth = originalCanvas.width * scaleFactor;
            const newHeight = originalCanvas.height * scaleFactor;

            const newCanvas = document.createElement('canvas');
            newCanvas.width = newWidth;
            newCanvas.height = newHeight;
            const ctx = newCanvas.getContext('2d');

            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            ctx.drawImage(originalCanvas, 0, 0, newWidth, newHeight);

            compressCanvas(newCanvas, targetBytes, 0.8, callback);
        }
    </script>
</body>
</html>
